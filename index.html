<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Google Drive OBJ Viewer</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#111; }
    #loading {
      position:absolute; top:10px; left:10px; color:#fff;
      background:rgba(0,0,0,.45); padding:6px 10px; border-radius:4px;
      font-family: sans-serif; font-size:13px;
    }
  </style>
</head>
<body>
<div id="loading">Loading 3D model from Google Drive...</div>

<script type="module">
  // Three.js + loaders from CDN
  import * as THREE from 'https://unpkg.com/three@0.165.0/build/three.module.js';
  import { OrbitControls } from 'https://unpkg.com/three@0.165.0/examples/jsm/controls/OrbitControls.js';
  import { MTLLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/MTLLoader.js';
  import { OBJLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/OBJLoader.js';

  // 1) 구글드라이브 파일 ID
  const OBJ_ID = "1uLNxVBnxp20Xn0anhrjG4YDkQPbHUi1E";
  const MTL_ID = "1KKqx8yjB3B7Hhn_d_2R_R1OsNFQNgwH4";
  const JPG_ID = "1sjRimp26-I2s_yYMQ0Grx_kigeYq5UAh";

  // 2) 드라이브 직접 다운로드 링크
  const driveObj = `https://drive.google.com/uc?export=download&id=${OBJ_ID}`;
  const driveMtl = `https://drive.google.com/uc?export=download&id=${MTL_ID}`;
  const driveJpg = `https://drive.google.com/uc?export=download&id=${JPG_ID}`;

  // 3) CORS 우회 프록시 (공개 프록시라 느릴 수 있음)
  const proxy = "https://corsproxy.io/?";

  const objURL = proxy + encodeURIComponent(driveObj);
  const mtlURL = proxy + encodeURIComponent(driveMtl);
  const texURL = proxy + encodeURIComponent(driveJpg);

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111);

  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 0.5, 3);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // light
  const hemi = new THREE.HemisphereLight(0xffffff, 0x222222, 0.7);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 0.85);
  dir.position.set(3, 4, 5);
  scene.add(dir);

  const loadingDiv = document.getElementById('loading');

  // texture
  const textureLoader = new THREE.TextureLoader();
  const texture = textureLoader.load(texURL);

  // MTL 먼저
  const mtlLoader = new MTLLoader();
  mtlLoader.load(
    mtlURL,
    (materials) => {
      materials.preload();

      // mtl 안에 텍스처 지정이 없을 수도 있으니 강제로 넣어둔다
      for (const k in materials.materials) {
        const mat = materials.materials[k];
        if (mat && !mat.map) {
          mat.map = texture;
          mat.needsUpdate = true;
        }
      }

      const objLoader = new OBJLoader();
      objLoader.setMaterials(materials);
      objLoader.load(
        objURL,
        (object) => {
          // 가운데 정렬
          const box = new THREE.Box3().setFromObject(object);
          const center = box.getCenter(new THREE.Vector3());
          object.position.sub(center);

          // 크기 맞추기
          const size = new THREE.Vector3();
          box.getSize(size);
          const maxAxis = Math.max(size.x, size.y, size.z);
          if (maxAxis > 0) {
            const scale = 2.0 / maxAxis;
            object.scale.setScalar(scale);
          }

          scene.add(object);
          loadingDiv.style.display = 'none';
        },
        (xhr) => {
          if (xhr.lengthComputable) {
            const p = xhr.loaded / xhr.total * 100;
            loadingDiv.textContent = `Loading OBJ... ${p.toFixed(0)}%`;
          } else {
            loadingDiv.textContent = 'Loading OBJ...';
          }
        },
        (err) => {
          console.error(err);
          loadingDiv.textContent = 'OBJ load failed (check Drive sharing)';
        }
      );
    },
    undefined,
    (err) => {
      console.error(err);
      loadingDiv.textContent = 'MTL load failed (check Drive sharing)';
    }
  );

  // resize
  window.addEventListener('resize', () => {
    const w = window.innerWidth;
    const h = window.innerHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
  });

  // loop
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();
</script>
</body>
</html>
