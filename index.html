<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Google Drive 3D Viewer</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#111; }
    #loading {
      position:absolute; top:10px; left:10px; color:#fff;
      background:rgba(0,0,0,0.45); padding:6px 10px; border-radius:4px;
      font-family: sans-serif; font-size:13px;
    }
  </style>

  <!-- ✅ 이제는 CDN이 아니라 로컬(lib)에서 불러옵니다 -->
  <script src="./libs/three.min.js"></script>
  <script src="./libs/OrbitControls.js"></script>
  <script src="./libs/MTLLoader.js"></script>
  <script src="./libs/OBJLoader.js"></script>
</head>

<body>
<div id="loading">Loading 3D model from Google Drive...</div>

<script>
window.addEventListener("load", function() {

  // ✅ Google Drive 파일 ID
  const OBJ_ID = "1uLNxVBnxp20Xn0anhrjG4YDkQPbHUi1E";
  const MTL_ID = "1KKqx8yjB3B7Hhn_d_2R_R1OsNFQNgwH4";
  const JPG_ID = "1sjRimp26-I2s_yYMQ0Grx_kigeYq5UAh";

  // ✅ Drive 다운로드 URL + CORS 프록시
  const proxy = "https://corsproxy.io/?";
  const objURL = proxy + encodeURIComponent(`https://drive.google.com/uc?export=download&id=${OBJ_ID}`);
  const mtlURL = proxy + encodeURIComponent(`https://drive.google.com/uc?export=download&id=${MTL_ID}`);
  const texURL = proxy + encodeURIComponent(`https://drive.google.com/uc?export=download&id=${JPG_ID}`);

  // === Three.js 기본 세팅 ===
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111);

  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 0.5, 3);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  const hemi = new THREE.HemisphereLight(0xffffff, 0x222222, 0.7);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 0.85);
  dir.position.set(3, 4, 5);
  scene.add(dir);

  const loadingDiv = document.getElementById("loading");

  // 텍스처
  const textureLoader = new THREE.TextureLoader();
  const texture = textureLoader.load(texURL);

  // MTL 먼저 로드
  const mtlLoader = new THREE.MTLLoader();
  mtlLoader.load(
    mtlURL,
    function(materials) {
      materials.preload();

      // mtl에 텍스처가 안 적혀 있으면 jpg 강제로 넣기
      for (const key in materials.materials) {
        const mat = materials.materials[key];
        if (mat && !mat.map) {
          mat.map = texture;
          mat.needsUpdate = true;
        }
      }

      // OBJ 로드
      const objLoader = new THREE.OBJLoader();
      objLoader.setMaterials(materials);
      objLoader.load(
        objURL,
        function(object) {
          // 가운데 맞추기
          const box = new THREE.Box3().setFromObject(object);
          const center = box.getCenter(new THREE.Vector3());
          object.position.sub(center);

          // 크기 조정
          const size = new THREE.Vector3();
          box.getSize(size);
          const maxAxis = Math.max(size.x, size.y, size.z);
          if (maxAxis > 0) {
            const scale = 2 / maxAxis;
            object.scale.setScalar(scale);
          }

          scene.add(object);
          loadingDiv.style.display = "none";
        },
        function(xhr) {
          if (xhr.lengthComputable) {
            const p = xhr.loaded / xhr.total * 100;
            loadingDiv.textContent = "Loading OBJ... " + p.toFixed(0) + "%";
          } else {
            loadingDiv.textContent = "Loading OBJ...";
          }
        },
        function(err) {
          console.error("OBJ load error:", err);
          loadingDiv.textContent = "OBJ load failed (check Drive sharing)";
        }
      );
    },
    undefined,
    function(err) {
      console.error("MTL load error:", err);
      loadingDiv.textContent = "MTL load failed (check Drive sharing)";
    }
  );

  // 창 크기 바뀔 때
  window.addEventListener("resize", function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // 렌더 루프
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

});
</script>
</body>
</html>
